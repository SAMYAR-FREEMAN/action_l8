name: CI

on:
  push:
    branches: [main]
  # این بخش اجازه می‌دهد دستی عدد را وارد کنید
  workflow_dispatch:
    inputs:
      test_number:
        description: 'Number to check (Enter 1 or 2)'
        required: true
        default: '1'

env:
  PORT: ${{secrets.PORT}}

jobs:
  test_project:
    runs-on: ubuntu-latest
    environment: testing_stage
    env:
      shole: ${{secrets.SHOLE}}
      PassWord: ${{secrets.PASSWORD}}
    steps:
      
      - uses: actions/checkout@v3

      - name: Using custom action
        id: test1
        uses: ./.github/actions/test1
        with:
          # اینجا می‌گوییم هر چیزی که کاربر تایپ کرد را بفرست به اکشن
          INPUT_NUM: "${{ inputs.test_number || '1' }}"

      - name: Print output of custom action
        run: |
          echo "The input was 1, so the result is: ${{ steps.test1.outputs.final_decision }}"

      - name: Set up Python 3.9
        uses: actions/setup-python@v3
        with:
          python-version: 3.9

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # چک می‌کند اگر فایل requirements وجود داشت نصب کند تا خطا ندهد
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Test with pytest
        continue-on-error: true
        run: |
          pytest -v

      - name: Unbreakable step
        if: always() 
        run: |
          echo "This step will always run."
          # ساخت یک فایل گزارش نمونه برای اینکه مرحله آپلود خطا ندهد
          echo "Test Report Content" > report.txt

      - name: Upload Report Txt
        uses: actions/upload-artifact@v5
        with:
          name: Report_Of_Test_Py3.9_Ubuntu
          path: report.txt

      - name: Print env
        run: |
          echo "PORT: ${{env.PORT}}"
          echo "shole: ${{env.shole}}"

  after_test_failure:
    needs: test_project
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Print failure message
        run: echo "Test failed!"

  run_project:
    needs: test_project
    runs-on: ubuntu-latest
    environment: deployment_stage
    env:
      shole: ${{secrets.SHOLE}}
    steps:
      - uses: actions/checkout@v3
      - name: Run the project
        run: echo "Running the project..."
      - name: Print Env
        run: |
          echo "PORT: ${{env.PORT}}"

  show_report:
    needs: test_project
    runs-on: ubuntu-latest
    steps:
      - name: Download Report Txt
        uses: actions/download-artifact@v5
        with:
          name: Report_Of_Test_Py3.9_Ubuntu
      - name: Display Report
        run: cat report.txt